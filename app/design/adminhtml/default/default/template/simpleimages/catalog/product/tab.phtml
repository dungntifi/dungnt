<?php
//data preset
//$product = Mage::getModel('catalog/product')->load($this->getRequest()->getParam('id')); 
$ids = Mage::getModel('catalog/product_type_configurable')->getChildrenIds($this->getRequest()->getParam('id'));   

$_subproducts = Mage::getModel('catalog/product')->getCollection()
    ->addAttributeToFilter('entity_id', $ids)
    ->addAttributeToSelect('color')-> groupByAttribute('color');

//echo "sub<pre>"; print_r($_subproducts->getData()); echo "</pre>";

$colors = '';
foreach ($_subproducts as $key => $value) {
	$attr = $value->getResource()->getAttribute("color");
	if ($attr->usesSource()) {
		$colors[$value['color']] = $attr->getSource()->getOptionText($value['color']);
	}
}

//echo "colors<pre>"; print_r($colors); echo "</pre>";
// $attr = $_product->getResource()->getAttribute("color");
// if ($attr->usesSource()) {
// echo $color_label = $attr->getSource()->getOptionText("10");
// }

// $productAttributes = Mage::getSingleton('eav/config')->getAttribute('catalog_product', 'color');
// if ($productAttributes->usesSource()) {
//     $allColorAttributes = $productAttributes->getSource()->getAllOptions(false);
// }

//echo "allColorAttributes<pre>"; print_r($allColorAttributes); echo "</pre>";

$_class = 'media_gallery_content';
$_jsObject = $_class . 'JsObject';
$_imageTypes = array("base_image_1" => "simpleimages_type['base_image_1']",
					 "base_image_2" => "simpleimages_type['base_image_2']",
					 "thumbnail" => "simpleimages_type['thumbnail']");

foreach ($colors as $colorId => $colorLabel):
?>
<div class="entry-edit">
	<div class="entry-edit-head">
		<h4 class="icon-head head-edit-form fieldset-legend">Associate images with color</h4>
		<div class="form-buttons"></div>
	</div>
	<div class="fieldset fieldset-wide">
		<div id="<?php echo $_class; ?>_color" >
			<div class="grid">
				<table cellspacing="0" class="data border" width="40%">
					<thead>
						<tr>
							<th>Color label</th>
							<th>Color icon</th>
							<th>Icon upload</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="color-label"><?php echo $colorLabel; ?></td>
							<td class="color-icon"><?php echo (Mage::helper('amconf')->getImageUrl($colorId) != '') ? '<img src="' . Mage::helper('amconf')->getImageUrl($colorId) . '" width="45" />' : '<p>No icon</p>'; ?></td>
							<td class="icon-upload"><input type="file" name="amconf_icon[<?php echo $colorId; ?>][]"></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div id="<?php echo $_class; ?>" >
			<div class="grid">
				<table cellspacing="0" class="data border" id="<?php echo $_class; ?>_grid" width="100%">
				    <thead>
				        <tr class="headings">
				            <th><?php echo Mage::helper('catalog')->__('Image') ?></th>
				            <th><?php echo Mage::helper('catalog')->__('Label') ?></th>
				            <th><?php echo Mage::helper('catalog')->__('Sort Order') ?></th>
				            <th><?php echo Mage::helper('catalog')->__('Base Image 1') ?></th>
				            <th><?php echo Mage::helper('catalog')->__('Base Image 2') ?></th>
				            <th><?php echo Mage::helper('catalog')->__('Thumbnail') ?></th>
				            <th><?php echo Mage::helper('catalog')->__('Exclude') ?></th>
				            <th class="last"><?php echo Mage::helper('catalog')->__('Remove') ?></th>
				        </tr>
				    </thead>
				    <tbody id="<?php echo $_class; ?>_list">
						<?php 

							foreach ($_subproducts as $key => $_subproduct) {

								if($_subproduct['color'] == $colorId) { 

									$sub = Mage::getModel('catalog/product')->load($_subproduct['entity_id']); 
									$gallery = $sub->getMediaGalleryImages();

									// echo "<pre>"; print_r($sub->getData('media_gallery')); echo "</pre>";

									// echo "gallery<pre>"; print_r($gallery); echo "</pre>";
									$i = 0;
									foreach ($gallery as $key => $image) {

									?>

									<tr id="<?php echo $_class; ?>_template" class="template">
						                <td class="cell-image"><img src="<?php echo $image->getUrl(); ?>" width="120" /></td>
						                <td class="cell-label"><input type="text" class="input-text" name="simpleimages_data[label][<?=$colorId?>][<?=$i?>]" value="<?php echo $image->getLabel(); ?>" /></td>
						                <td class="cell-position"><input type="text" class="input-text validate-number" name="simpleimages_data[position][<?=$colorId?>][<?=$i?>]" value="<?php echo $image->getPosition(); ?>" /></td>
						                <?php foreach ($_imageTypes as $typeId=>$type): ?>
						                	<td class="cell-<?php echo $typeId ?> a-center"><input type="radio" name="<?php echo $type ?>" value="__file__" /></td>
						                <?php endforeach; ?>
						                <td class="cell-disable a-center"><input type="checkbox" name="simpleimages_data[exclude][<?=$colorId?>][<?=$i?>]"</td>
						                <td class="cell-remove a-center last"><input type="checkbox" name="simpleimages_data[remove][<?=$colorId?>][<?=$i?>]" /></td>
						        	</tr>

								<?
										$i++;
									}
									// $sub = Mage::getModel('catalog/product')->load($_subproduct['entity_id']); 
									// $gallery = $sub->getMediaGalleryImages();
									// $galleryWidth = count($gallery) * 160; //gallery-item width + margin

									// //data load
									// $imagesGallery = '<div class="images-gallery" style="width: ' . $galleryWidth . 'px;">';

									// $i = 0;
									// foreach ($gallery as $key => $image) {
									// 	$checked = ($i == 0) ? 'checked' : '';
									// 	$imagesGallery .= '<div class="gallery-item">
									// 		<img src="' . $image->getUrl() . '" width="120" />
									// 		<input type="checkbox" style="display:none;" name="simpleimages_gallery[' . $_subproduct['entity_id'] . '][' . $key . ']" value="' . $image->getFile() . '" />
									// 		<fieldset>
									// 			<legend>Set image type</legend>
									// 			<input type="radio" ' . $checked . ' value="' . $key . '" name="simpleimages_type[' . $_subproduct['entity_id'] . '][image]"> Base image<br>
									// 			<input type="radio" ' . $checked . ' value="' . $key . '" name="simpleimages_type[' . $_subproduct['entity_id'] . '][small_image]"> Small image<br>
									// 			<input type="radio" ' . $checked . ' value="' . $key . '" name="simpleimages_type[' . $_subproduct['entity_id'] . '][thumbnail]"> Thumbnail
									// 		</fieldset>
									// 	</div>';
									// 	$i++;
									// }
									// $imagesGallery .= '</div>';
									// echo $imagesGallery;
									// $imagesGallery = '';
								}
							}

						?>
				    </tbody>
				    <tfoot>
				        <tr class="simpleimages-uploader">
				            <td style="padding:8px">
				               	<input type="file" name="simpleimages_gallery[<?php echo $colorId; ?>][]">
				            </td>
				        	<td colspan="7" style="padding:10px">
				        		<a href='#' class="upload-one-more-image" data-color="<?php echo $colorId; ?>">Add another image</a>
				        	</td>
				        </tr>
				    </tfoot>
				</table>
			</div>
		</div>
	</div>
</div>
<?php endforeach; ?>

<script>
	jQuery(document).ready(function() {

		//add image uploader
		jQuery('.upload-one-more-image').on('click', function(e) {
			e.preventDefault();
			var colorId = jQuery(this).data('color');
			jQuery(this).parents('tfoot').append('<tr><td style="padding:8px"><input type="file" name="simpleimages_gallery[' + colorId + '][]"></td><td colspan="7" style="padding: 10px;"><a href="#" class="remove-uploader">Remove</a></td></tr>');
		});

		//remove image uploader
		jQuery('tfoot').on('click', '.remove-uploader', function(e) {
			e.preventDefault();
			jQuery(this).parents('tr').remove();
		});
	});
</script>