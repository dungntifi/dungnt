<style>
	#color-chooser {
		position: relative;
		display: none;
		border-bottom: 1px solid #d6d6d6;
		margin-bottom: 10px;
	}

	#color-chooser td, th {
		text-align: center;
		padding: 5px;
	}

	#color-chooser .images-gallery {
		text-align: center;
	}

	#color-chooser .images-gallery img {
		width: 144px;
		margin: 3px 0;
	}

	#color-chooser .gallery-item {
		width: 150px;
		display: inline-block;
		text-align: center;
		margin: 0 5px;
	}

	#color-chooser .gallery-item .checked {
		border: 3px solid #eb5e00;
		margin: 0;
	}

	#color-chooser .gallery-item fieldset {
		text-align: left; 
		margin-top: 15px;
	}

	#color-chooser .gallery-item fieldset legend {
		display: block; 
		width: auto; 
		visibility: visible; 
		overflow: visible;
	}

	#color-chooser .selected-images {
		display: block;
		max-width: 500px;
		overflow-y: hidden;
		position: relative;
	}

	#color-chooser .selected-remove {
		vertical-align: middle;
	}
</style>

<?php
//data preset
$product = Mage::getModel('catalog/product')->load($this->getRequest()->getParam('id')); 
$childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null,$product);   

$simpleOptions = '<option selected="selected">--- Select simple product ---</option>';
foreach($childProducts as $_simple) {
    $simpleOptions .= '<option value="' . $_simple->getId() . '">' . $_simple->getName() . '</option>'; 
}
?>

<div class="entry-edit">
	<div class="entry-edit-head">
		<h4 class="icon-head head-edit-form fieldset-legend">Simple product color and image configuration</h4>
	</div>
</div>
<div class="entry-edit">
	<div class="fieldset">
		<table id="color-chooser">
			<thead>
				<tr>
					<th>Selected simple product</th>
					<th>Assign simple product color</th>
					<th>Click on image to assign it (loaded from configurable product gallery)</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<div id="add-row">Choose simple product to configure: 
			<select name="simple_chooser" class="select">
	    		<?php echo $simpleOptions; ?>
	    	</select>
	    </div>
	</div>
</div>

<script>
	jQuery(document).ready(function() {

		jQuery('#add-row select').on('change', function() {
			var simpleId = jQuery(this).val(),
				simpleName = jQuery(this).find('option:selected').text();
			jQuery('#loading-mask').show();

			jQuery.ajax({
				url: '<?php echo $this->getUrl("simpleimages/index/index/") ?>',
				cache: false,
				data: {'productId': <?php echo $this->getRequest()->getParam('id'); ?>, 'simpleId': simpleId, 'simpleName': simpleName},
				complete: function (xhr, status) {
				    if (status === 'error' || !xhr.responseText) {
				        alert('Error processing request for simple product id = ' + simpleId);
				        jQuery('#loading-mask').hide();
				    }
				    else {
				        var data = xhr.responseText;
						jQuery('#loading-mask').hide();
					    jQuery('#color-chooser').show();
						jQuery('#color-chooser tbody').append(data);
					}
				}
			});			

			//set "selected" option to default
			jQuery('#add-row select option').prop("selected", false);
		});

		//remove
		jQuery('#color-chooser').on('click', '.selected-remove a', function(){
			jQuery(this).parents('.row').remove();
			if(jQuery('#color-chooser tbody tr').length == 0) {
				jQuery('#color-chooser').hide();
			}
		});

		//gallery img click -> checkbox toggle
		jQuery('#color-chooser').on('click', '.gallery-item img', function() {
			jQuery(this).toggleClass('checked');
			jQuery(this).next('input[type="checkbox"]').prop('checked', function (i, value) {
			    return !value;
			});
		});
	});
</script>