<style>
	#color-chooser {
		position: relative;
		display: none;
		border-bottom: 1px solid #d6d6d6;
		margin-bottom: 10px;
	}

	#color-chooser td, th {
		text-align: center;
		padding: 5px;
	}

	#color-chooser .images-gallery {
		text-align: center;
	}

	#color-chooser .images-gallery img {
		width: 144px;
		margin: 3px 0;
	}

	#color-chooser .gallery-item {
		width: 150px;
		display: inline-block;
		text-align: center;
		margin: 0 5px;
	}

	#color-chooser .gallery-item .checked {
		border: 3px solid #eb5e00;
		margin: 0;
	}

	#color-chooser .gallery-item fieldset {
		text-align: left; 
		margin-top: 15px;
	}

	#color-chooser .gallery-item fieldset legend {
		display: block; 
		width: auto; 
		visibility: visible; 
		overflow: visible;
	}

	#color-chooser .selected-images {
		display: block;
		max-width: 500px;
		overflow-y: hidden;
		position: relative;
	}

	#color-chooser .selected-remove {
		vertical-align: middle;
	}

	#configurable-gallery {
		display: none;
	}
</style>

<?php
//data preset
$_productId = $this->getRequest()->getParam('id') . "<br>";
$product = Mage::getModel('catalog/product')->load($_productId); 
$childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null,$product);   

$productAttributes = Mage::getSingleton('eav/config')->getAttribute('catalog_product', 'color');
if ($productAttributes->usesSource()) {
    $options = $productAttributes->getSource()->getAllOptions(false);
}

$gallery = $product->getMediaGalleryImages();
$galleryWidth = count($gallery) * 160; //gallery-item width + margin

//data load
$imagesGallery = '<div class="images-gallery" style="width: ' . $galleryWidth . 'px;">';

$i = 0;
foreach ($gallery as $key => $image) {
	$checked = ($i == 0) ? 'checked' : '';
	$imagesGallery .= '<div class="gallery-item">
		<img src="' . $image->getUrl() . '" />
		<input type="checkbox" style="display:none;" name="simpleimages_gallery[_replace_][' . $key . ']" value="' . $image->getFile() . '" />
		<fieldset>
			<legend>Set image type</legend>
			<input type="radio" ' . $checked . ' value="' . $key . '" name="simpleimages_type[_replace_][image]"> Base image<br>
			<input type="radio" ' . $checked . ' value="' . $key . '" name="simpleimages_type[_replace_][small_image]"> Small image<br>
			<input type="radio" ' . $checked . ' value="' . $key . '" name="simpleimages_type[_replace_][thumbnail]"> Thumbnail
		</fieldset>
	</div>';
	$i++;
}
$imagesGallery .= '</div>';

$simpleOptions = '<option selected="selected">--- Select simple product ---</option>';
foreach($childProducts as $_simple) {
    $simpleOptions .= '<option value="' . $_simple->getId() . '">' . $_simple->getName() . '</option>'; 
}

$colorOptions = '';
foreach ($options as $option) {
	$colorOptions .= '<option value="' . $option['value'] . '">' . $option['label'] . '</option>';
}
?>

<div class="entry-edit">
	<div class="entry-edit-head">
		<h4 class="icon-head head-edit-form fieldset-legend">Simple product color and image configuration</h4>
	</div>
</div>
<div class="entry-edit">
	<div class="fieldset">
		<table id="color-chooser">
			<thead>
				<tr>
					<th>Selected simple product</th>
					<th>Assign simple product color</th>
					<th>Click on image to assign it (loaded from configurable product gallery)</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<div id="add-row">Choose simple product to configure: 
			<select name="simple_chooser" class="select">
	    		<?php echo $simpleOptions; ?>
	    	</select>
	    </div>
	    <div id="configurable-gallery"><?php echo $imagesGallery; ?></div>
	</div>
</div>

<script>
	jQuery(document).ready(function() {
		var galleryTemplate = jQuery('#configurable-gallery').html();
			jQuery('#configurable-gallery').remove(); //delete template, to avoid sending it`s data in POST

		jQuery('#add-row select').on('change', function() {
			var simpleId = jQuery(this).val();
			var gallery = galleryTemplate.replace(/_replace_/g, simpleId);
			var row = '<tr class="row" id="simpleimages-' + simpleId + '"><td class="selected-simple">' + jQuery(this).find('option:selected').text() + '</td><td class="selected-color input-field"><select name="simpleimages_color[' + simpleId + ']" class="required-entry select"><?php echo $colorOptions; ?></select></td><td class="selected-images input-field">' + gallery + '</td><td class="selected-remove"><p>Remove this row, if you don`t want<br>to change this simple product</p><a href="#" class="button">Remove</a></td></tr>';
			jQuery('#color-chooser').show();
			jQuery('#color-chooser tbody').append(row);

			//set "selected" option to default
			jQuery('#add-row select option').prop("selected", false);
		});

		//remove
		jQuery('#color-chooser').on('click', '.selected-remove a', function(){
			jQuery(this).parents('.row').remove();
			if(jQuery('#color-chooser tbody tr').length == 0) {
				jQuery('#color-chooser').hide();
			}
		});

		//gallery img click -> checkbox toggle
		jQuery('#color-chooser').on('click', '.gallery-item img', function() {
			jQuery(this).toggleClass('checked');
			jQuery(this).next('input[type="checkbox"]').prop('checked', function (i, value) {
			    return !value;
			});
		});
	});
</script>