<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2010 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>


<div class="order-items">
    <?php if ($this->helper('giftmessage/message')->getIsMessagesAvailable('items', $this->getOrder())): ?>
    <script type="text/javascript">
    //<![CDATA[
    function giftMessageToogle(giftMessageIdentifier)
    {
        var link = $('order-item-gift-message-link-'+giftMessageIdentifier);
        var container = $('order-item-gift-message-'+giftMessageIdentifier);
        var row = $('order-item-row-'+giftMessageIdentifier);
        if(link.expanded) {
            link.expanded = false;
            link.removeClassName('expanded');
            if(container.hasClassName('last')) {
                row.addClassName('last');
            }
            container.hide();
        } else {
            link.expanded = true;
            link.addClassName('expanded');
            if(container.hasClassName('last')) {
                row.removeClassName('last');
            }
            container.show();
        }
    
        return false;
    }
    //]]>
    </script>
    <?php endif; ?>
    <?php $_order = $this->getOrder() ?>
<?php if ($_order->getTracksCollection()->count()) : 
	  
	 $trackUrl = explode('/', $this->helper('shipping')->getTrackingPopupUrlBySalesModel($_order));
	 $hashstring = $trackUrl[count($trackUrl)-2]; 
	 
	  $shippingInfoModel = Mage::getModel('shipping/info')->loadByHash($hashstring);
      Mage::register('current_shipping_info', $shippingInfoModel);
	  $_results = $this->getTrackingInfo(); 
	  
	
?>   
    <div class="col2-set order-info-box">
    <div class="col">
        <div class="box">
            <div class="box-title">
                <h2><?php echo $this->__('Order Tracking Information') ?></h2>
            </div>
            <div class="box-content">
                <table width="100%" style="padding-right:10px;padding-left:10px;">
                    <tr>
                        <td id="trackdata" class="normal_text_13px">
                        		Loading Please wait...
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
<?php endif; ?>


    <h2><?php echo $this->__('Items Ordered') ?>
        <?php if ($_order->getTracksCollection()->count()) : ?>
            <span class="separator"></span> 
        <?php endif; ?>
    </h2>

    <?php echo $this->getChildHtml('order_items') ?>

    <?php if($this->helper('giftmessage/message')->getIsMessagesAvailable('order', $_order) && $_order->getGiftMessageId()): ?>
    <div class="order-gift-message">
        <h2><?php echo $this->__('Gift Message for This Order') ?></h2>
        <?php $_giftMessage=$this->helper('giftmessage/message')->getGiftMessageForEntity($_order); ?>
        <dl class="gift-message">
            <dt><strong><?php echo $this->__('From:') ?></strong> <?php echo $this->htmlEscape($_giftMessage->getSender()) ?></dt>
            <dt><strong><?php echo $this->__('To:') ?></strong> <?php echo $this->htmlEscape($_giftMessage->getRecipient()) ?></dt>
            <dd><?php echo $this->helper('giftmessage/message')->getEscapedGiftMessage($_order) ?></dd>
        </dl>
    </div>
    <?php endif; ?>
    <?php $_history = $this->getOrder()->getVisibleStatusHistory() ?>
    <?php if (count($_history)): ?>
    <div class="order-about">
        <h2><?php echo $this->__('About Your Order') ?></h2>
        <dl>
            <?php foreach ($_history as $_historyItem): ?>
                <dt><?php echo $this->formatDate($_historyItem->getCreatedAtStoreDate(), 'medium', true) ?></dt>
                <dd><?php echo $this->escapeHtml($_historyItem->getComment()) ?></dd>
            <?php endforeach; ?>
        </dl>
    </div>
    <?php endif; ?>
</div>

<?php if ($_order->getTracksCollection()->count()) : ?>
<script>
new Ajax.Request('<?php echo Mage::helper('ordertracking')->getTrackingPopupUrlBySalesModel($_order) ?>',
  {
    method:'get',
    onSuccess: function(transport){
      var response = transport.responseText;
	  document.getElementById('trackdata').innerHTML=response;
    },
    onFailure: function(){ 'There is no tracking available.'; }
  });
</script>
<?php endif; ?>

	        </div>
	        <div class="contact-us-widget span3 push--one-eighth">
                <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('help_contact')->toHtml(); ?>
	        </div>
		</div>
	</div>
</div>